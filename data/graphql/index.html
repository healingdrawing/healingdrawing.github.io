<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="billboard.pkgd.min.js"></script>
    <style type="text/css">
      body {
        color: lightgray;
        background-color: black;
        align-content: center;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        border: 1px solid;
      }

      #rotatedAxisGroupedBar .base-line line {
        stroke-width: 3px;
        stroke: #000;
      }
    </style>
    <title>User Information</title>
  </head>
  <body>
    <h1>User Information</h1>
    <span id="userLogin"></span>
    <div id="rotatedAxisGroupedBar"></div>

    <table>
      <tr>
        <th>User ID</th>
        <th>User Login</th>
      </tr>
      <tbody id="users"></tbody>
    </table>

    <!-- the task minimum requirements
  You will have to create a profile UI where you can see your own school information.
  This information/data is present on the graphQL endpoint, where you will have to query it.
  
  Your profile must have at least 3 sections of content at your choice, for example:
  - Basic user identification
  - XP amount
  - level
  
  Beside those sections it will have a mandatory section for the generation of statistic graphs.
  You will have to do at least two different statistic graphs for the data given.
  - XP earned in a time period (progress over time)
  - Levels over time
  
  You must use all the types of querying present above (normal, nested and using arguments), do not forget that you can use the types together or separately.

  normal query(to get id from the login):
  
  {
    user (where: { login: { _eq: "lenivaya10003" }}) {
      id 
      login
    }
  }
  
  query with parameters:
  
  {
    transaction (where: { userId: { _eq: 465 }}) {
      id 
      amount
      type
      createdAt
    }
  }

  query with nested syntax and with parameters(use login to check was login changed... data corrupted... or not):
  
  {
  transaction (where: { userId: { _eq: 465 }}) {
    id - looks like not available...strange, removed and works at the moment
    type
    amount
    user{
      login
    }
    createdAt
  }
}

  
implement first get the user id from the login inside input box, default value is "lenivaya10003"

if login not found, show message "user with login ... not found"
else fetch the data from the server and show it on screen using graphics

  -->

    <script>
      var userLogin;
      var userXp;

      fetch("https://01.gritlab.ax/api/graphql-engine/v1/graphql", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query:
            '{user(where: { login: { _eq: "lenivaya10003" } }) { id login } }',
        }),
      })
        .then((res) => res.json())
        .then((res) => {
          const users = res.data.user;
          const tbody = document.getElementById("users");
          users.forEach((user) => {
            //if (user.login === "lenivaya10003"){
            const tr = document.createElement("tr");
            // const idTd = document.createElement('td');
            const loginTd = document.createElement("td");
            // idTd.textContent = user.id;
            loginTd.textContent = user.login;
            // tr.appendChild(idTd);
            tr.appendChild(loginTd);
            tbody.appendChild(tr);
            //}

            // now use the user.id to fetch the data from the server, and show it on screen using graphics
            console.log("user.id ", user.id);
            fetch("https://01.gritlab.ax/api/graphql-engine/v1/graphql", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                query: `{ transaction (where: { userId: { _eq: ${user.id} }}) { path type amount user{ login } createdAt } }`,
              }),
            })
              .then((res) => res.json())
              .then((rez) => {
                console.log(rez);
                const transactions = rez.data.transaction;

                /*sort transactions by time*/
                transactions.sort((a, b) => {
                  return new Date(a.createdAt) - new Date(b.createdAt);
                });

                /*filter only transactions where type === "xp", and sorted by date createdAt ascending*/
                const xpTransactions = transactions
                  .filter((transaction) => transaction.type === "xp")
                  .sort((a, b) => {
                    return new Date(a.createdAt) - new Date(b.createdAt);
                  });
                console.log("xpTransactions ", xpTransactions);

                const tbody = document.getElementById("users");
                transactions.forEach((transaction) => {
                  const tr = document.createElement("tr");
                  const typeTd = document.createElement("td");
                  const amountTd = document.createElement("td");
                  const loginTd = document.createElement("td");
                  const createdAtTd = document.createElement("td");
                  typeTd.textContent = transaction.type;
                  amountTd.textContent = transaction.amount;
                  loginTd.textContent = transaction.user.login;
                  // time in milliseconds
                  tms = Date.parse(transaction.createdAt);
                  // time in seconds
                  tss = tms / 1000;
                  createdAtTd.textContent = tss;
                  //createdAtTd.textContent = transaction.createdAt;

                  tr.appendChild(typeTd);
                  tr.appendChild(amountTd);
                  // tr.appendChild(loginTd);
                  tr.appendChild(createdAtTd);
                  tbody.appendChild(tr);
                });
              })
              .catch((err) => console.error(err));
          });
        })
        .catch((err) => console.error(err));

      var chart = bb.generate({
        data: {
          columns: [
            ["Male", -83, -143, -100, -120, -150, -85],
            ["Female", 130, 100, 140, 175, 150, 50],
          ],
          type: "bar", // for ESM specify as: bar()
          groups: [["Male", "Female"]],
          labels: {
            format: function (v, id) {
              return Math.abs(v);
            },
          },
        },
        axis: {
          rotated: true,
          x: {
            show: false,
          },
          y: {
            tick: {
              format: function (v) {
                return Math.abs(v);
              },
            },
          },
        },
        grid: {
          y: {
            show: true,
            lines: [
              {
                value: 0,
                class: "base-line",
              },
            ],
          },
        },
        tooltip: {
          format: {
            value: function (v) {
              return Math.abs(v);
            },
          },
        },
        bindto: "#rotatedAxisGroupedBar",
      });
    </script>
  </body>
</html>
